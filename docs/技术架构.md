# AI写作工具技术架构设计

## 概述

本技术架构设计基于AI写作工具项目规划，旨在构建一个功能完整、可扩展的智能写作助手。该工具将支持内容生成、编辑、模板管理、内容存储、上下文压缩和创意提示等功能，同时具备良好的扩展性以支持未来功能增强。

## 技术架构选择

### 桌面应用框架：Tauri
- **理由**: 相比Electron，Tauri生成的应用程序体积更小，内存占用更低
- **优势**: Rust后端提供更好的性能和安全性，更好的系统资源集成能力
- **适用性**: 适合需要一定计算能力的AI写作工具

### 后端架构：Python + FastAPI
- **语言**: Python 3.10+，AI/ML生态丰富
- **Web框架**: FastAPI，性能优秀，支持异步处理
- **集成方式**: 将FastAPI服务嵌入Tauri应用中，通过localhost通信

### AI框架：LangGraph + LangChain
- **LangGraph**: 用于构建复杂的AI工作流，适合多步骤创作过程
- **LangChain**: 用于提示词管理、模型交互等基础功能

### 数据库：SQLite + SQLAlchemy
- **SQLite**: 轻量级，适合桌面应用，无需额外安装数据库服务
- **SQLAlchemy**: 强大的ORM，便于数据库操作

### 前端：React + TypeScript
- **React**: 组件化开发，生态系统成熟
- **TypeScript**: 提供类型安全，减少错误
- **Tailwind CSS**: 实用优先的CSS框架

### AI模型策略
- **本地模型**: 通过Ollama或llama.cpp支持，保证离线可用性
- **云端模型**: API接口兼容多种提供商（OpenAI、Anthropic等）
- **灵活性**: 用户可根据需要选择模型来源

## 详细架构设计

### 桌面应用架构
- **框架**: Tauri (Rust + Web技术)
- **前端**: React + TypeScript + Tailwind CSS
- **通信**: 前端通过Tauri命令调用后端API

### 后端架构
- **语言**: Python 3.10+
- **Web框架**: FastAPI
- **AI框架**: LangGraph + LangChain
- **数据库**: SQLite + SQLAlchemy ORM
- **异步处理**: asyncio用于长时间运行的AI任务

### AI模型部署策略
- **本地模型**: Ollama集成，支持多种开源模型
- **云端模型**: API接口兼容多种提供商
- **模型选择**: 用户可配置默认模型及备选方案

### 数据管理
- **作品存储**: SQLite数据库
- **状态管理**: 会话状态持久化
- **版本控制**: 内置简单版本历史
- **缓存机制**: 临时缓存AI生成结果和上下文

### 核心组件设计
1. **ContentGenerator**: AI内容生成核心
2. **TemplateManager**: 提示词模板管理系统
3. **ContextCompressor**: 上下文压缩与提炼
4. **StateManager**: 会话状态管理
5. **StyleAnalyzer**: 文风分析与一致性维护

## 扩展功能实现方案

### 1. AI校对功能
- **实现方式**: 集成专门的校对模型或规则引擎
- **架构位置**: 在ContentGenerator模块中增加proofreading子模块
- **数据存储**: 在数据库中增加校对记录表，存储发现的问题和建议
- **集成方法**: 通过LangChain的工具链集成语法检查和风格统一性检查

### 2. 情感与节奏控制
- **实现方式**: 使用情感分析模型和文本分析算法
- **架构位置**: 新增EmotionAnalyzer模块，分析文本的情感曲线和节奏
- **数据存储**: 在章节表中增加情感标签和节奏指标字段
- **可视化**: 前端图表组件展示情感波动和节奏变化

### 3. 批注系统
- **实现方式**: 在编辑器中集成批注功能
- **架构位置**: ContentEditor组件中增加批注层
- **数据存储**: 创建annotations表，关联到具体作品和文本位置
- **同步机制**: 支持批注与内容的实时同步

### 4. 创作日志
- **实现方式**: 自动记录创作活动和手动添加的备注
- **架构位置**: StateManager模块中增加日志记录功能
- **数据存储**: 创建creation_logs表，记录时间戳、操作类型、用户备注等
- **可视化**: 提供日志查看界面，按时间轴展示创作历程

### 5. AI反馈学习
- **实现方式**: 实现强化学习机制，根据用户修改调整AI输出
- **架构位置**: 在ContentGenerator中增加Learning模块
- **数据存储**: 创建feedback_records表，存储用户修改和偏好数据
- **算法**: 使用对比学习算法，训练AI理解用户偏好

### 6. 个性化工作区
- **实现方式**: 可配置的界面布局和功能模块
- **架构位置**: 前端使用状态管理存储用户布局偏好
- **数据存储**: 在users表中增加workspace_config字段存储布局设置
- **实现**: 使用拖拽组件库实现可定制的界面

## 架构扩展性优势

### 模块化设计
- 核心功能模块化，便于新增功能
- 松耦合架构，扩展功能不影响主流程

### 插件系统
- 设计插件接口，支持第三方功能扩展
- 允许用户按需启用/禁用特定功能

### 数据驱动
- 统一的数据模型设计，便于添加新的数据属性
- 灵活的数据库结构，支持功能扩展

### API友好
- 清晰的API边界，便于前后端分离开发
- 为未来的云端同步或协作功能预留接口

## 数据库设计

### 主要数据表
```sql
-- 作品表
CREATE TABLE works (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR(255),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 章节表
CREATE TABLE chapters (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    work_id INTEGER,
    title VARCHAR(255),
    content TEXT,
    position INTEGER,
    compressed_summary TEXT,
    emotion_score REAL,
    rhythm_metrics JSON,
    FOREIGN KEY (work_id) REFERENCES works(id)
);

-- 角色设定表
CREATE TABLE characters (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    work_id INTEGER,
    name VARCHAR(255),
    description TEXT,
    traits TEXT,
    FOREIGN KEY (work_id) REFERENCES works(id)
);

-- 世界设定表
CREATE TABLE world_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    work_id INTEGER,
    name VARCHAR(255),
    description TEXT,
    FOREIGN KEY (work_id) REFERENCES works(id)
);

-- 模板表
CREATE TABLE templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(255),
    content TEXT,
    template_type VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 会话状态表
CREATE TABLE session_states (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    work_id INTEGER,
    user_id INTEGER,
    session_data JSON,
    last_accessed TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (work_id) REFERENCES works(id)
);

-- 版本历史表
CREATE TABLE version_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    work_id INTEGER,
    chapter_id INTEGER,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version_notes TEXT,
    FOREIGN KEY (work_id) REFERENCES works(id),
    FOREIGN KEY (chapter_id) REFERENCES chapters(id)
);

-- 批注表
CREATE TABLE annotations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    work_id INTEGER,
    chapter_id INTEGER,
    content_position INTEGER,
    annotation_text TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (work_id) REFERENCES works(id),
    FOREIGN KEY (chapter_id) REFERENCES chapters(id)
);

-- 创作日志表
CREATE TABLE creation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    work_id INTEGER,
    action_type VARCHAR(50),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (work_id) REFERENCES works(id)
);

-- 反馈记录表
CREATE TABLE feedback_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    original_content TEXT,
    modified_content TEXT,
    feedback_type VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```
## 部署与打包

### 桌面应用打包
- 使用Tauri CLI工具进行应用打包
- 支持Windows、macOS和Linux平台
- 包含必要的AI模型运行时环境

### 依赖管理
- Python依赖通过requirements.txt管理
- 前端依赖通过package.json管理
- Rust依赖通过Cargo.toml管理

## 安全考虑

### 数据安全
- 本地数据加密存储
- API密钥安全存储机制
- 用户隐私保护措施

### 应用安全
- Tauri沙箱机制限制权限
- 输入验证防止注入攻击
- 安全的API通信协议